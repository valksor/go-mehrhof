name: Release

on:
    release:
        types: [ published ]

concurrency:
    group: release-${{ github.ref }}
    cancel-in-progress: false

permissions:
    contents: write
    packages: write
    id-token: write

env:
    GO_VERSION: '1.25'

jobs:
    release:
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout
                uses: actions/checkout@v6
                with:
                    fetch-depth: 0

            -   name: Set up Go
                uses: actions/setup-go@v6
                with:
                    go-version: ${{ env.GO_VERSION }}
                    cache: true

            -   name: Install Cosign
                uses: sigstore/cosign-installer@v3

            -   name: Install Syft
                uses: anchore/sbom-action/download-syft@v0

            -   name: Run GoReleaser
                uses: goreleaser/goreleaser-action@v6
                with:
                    version: latest
                    args: release --clean ${{ github.event.release.prerelease && '--snapshot' || '' }}
                env:
                    GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
                    GORELEASER_CURRENT_TAG: ${{ !github.event.release.prerelease && github.event.release.tag_name || '' }}

            -   name: Upload artifacts to release
                if: github.event.release.prerelease
                env:
                    GH_TOKEN: ${{ secrets.GH_TOKEN }}
                    RELEASE_TAG: ${{ github.event.release.tag_name }}
                run: |
                    # Upload binaries with correct names (format: binary keeps them in subdirs)
                    gh release upload "$RELEASE_TAG" \
                        "dist/mehr_linux_amd64_v1/mehr#mehr-linux-amd64" \
                        "dist/mehr_linux_arm64_v8.0/mehr#mehr-linux-arm64" \
                        "dist/mehr_darwin_amd64_v1/mehr#mehr-darwin-amd64" \
                        "dist/mehr_darwin_arm64_v8.0/mehr#mehr-darwin-arm64" \
                        dist/checksums.txt \
                        --clobber
