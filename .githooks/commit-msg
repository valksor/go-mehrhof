#!/bin/bash
# commit-msg hook: Add [skip ci] when no code changes
#
# Code paths that trigger CI:
#   - cmd/       (CLI commands)
#   - internal/  (core packages)
#   - go.mod     (dependencies)
#   - go.sum     (dependency checksums)
#   - Makefile   (build configuration)

COMMIT_MSG_FILE="$1"

# Code paths regex (triggers CI build)
CODE_PATHS="^cmd/|^internal/|^go\.mod$|^go\.sum$|^Makefile$"

# Get staged files
STAGED_FILES=$(git diff --cached --name-only)

# If nothing staged (e.g., amend), check HEAD commit files instead
if [ -z "$STAGED_FILES" ]; then
    STAGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD 2>/dev/null)
fi

# If still empty, don't touch the message (conservative)
if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# Check if any staged file matches code paths
if echo "$STAGED_FILES" | grep -qE "$CODE_PATHS"; then
    # Has code changes - do nothing
    exit 0
fi

# No code changes - add [skip ci] if not already present
FIRST_LINE=$(head -n 1 "$COMMIT_MSG_FILE")

if [[ "$FIRST_LINE" != *"[skip ci]"* ]] && [[ "$FIRST_LINE" != *"[ci skip]"* ]]; then
    # macOS sed requires '' after -i, Linux doesn't - use temp file for portability
    sed "1s/$/ [skip ci]/" "$COMMIT_MSG_FILE" > "$COMMIT_MSG_FILE.tmp"
    mv "$COMMIT_MSG_FILE.tmp" "$COMMIT_MSG_FILE"
fi

exit 0
